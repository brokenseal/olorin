"use strict";
var Events, ExperimentalProxyEventManager, ExtendedProxyEventManager, MessageQueue, ProxyEventManager, Session, Subscription, _,
  __slice = [].slice,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

_ = require('underscore');

MessageQueue = (function() {
  function MessageQueue(limit) {
    this.limit = limit != null ? limit : 1000;
    this.queue = [];
  }

  MessageQueue.prototype.purge = function() {
    if (this.queue.length > this.limit) {
      return this.queue.splice(this.limit, this.queue.length - this.limit);
    }
  };

  MessageQueue.prototype.push = function(object) {
    this.purge();
    return this.queue.push(object);
  };

  MessageQueue.prototype.getLastItems = function(length) {
    if (length == null) {
      length = 100;
    }
    return this.queue.slice(0, length);
  };

  return MessageQueue;

})();

Session = (function() {
  function Session(messageQueueLimit) {
    this.messageQueueLimit = messageQueueLimit;
    this.pose = null;
    this.messagesQueue = new MessageQueue(this.messageQueueLimit);
    this.arm = this.direction = this.version = this.connectedTimestamp = this.armRecognizedTimestamp = null;
    this.extra = {};
  }

  Session.prototype.initialize = function() {};

  Session.prototype.onConnected = function(version, connectedTimestamp) {
    this.connectedTimestamp = connectedTimestamp;
    return this.version = version.join('.');
  };

  Session.prototype.onArmRecognized = function(arm, direction, armRecognizedTimestamp) {
    this.arm = arm;
    this.direction = direction;
    this.armRecognizedTimestamp = armRecognizedTimestamp;
  };

  Session.prototype.close = function() {};

  return Session;

})();

Subscription = (function() {
  function Subscription(callback, index, subscriptionList) {
    this.callback = callback;
    this.index = index;
    this.subscriptionList = subscriptionList;
  }

  Subscription.prototype.invoke = function() {
    var args;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return this.callback.apply(this, args);
  };

  Subscription.prototype.dispose = function() {
    return this.subscriptionList.splice(this.index, 0);
  };

  return Subscription;

})();

Events = (function() {
  function Events() {
    this.events = {};
  }

  Events.prototype.on = function(eventName, listener) {
    var subscription, subscriptionList;
    if (!this.events[eventName]) {
      this.events[eventName] = [];
    }
    subscriptionList = this.events[eventName];
    subscription = new Subscription(listener, subscriptionList.length, subscriptionList);
    subscriptionList.push(subscription);
    return subscription;
  };

  Events.prototype.trigger = function() {
    var args, eventName, len, subscription, subscriptionList, _results;
    eventName = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    subscriptionList = this.events[eventName] || [];
    len = subscriptionList.length;
    _results = [];
    while (len--) {
      subscription = subscriptionList[len];
      _results.push(subscription.invoke.apply(subscription, args));
    }
    return _results;
  };

  Events.prototype.off = function(eventName) {
    return this.events[eventName] = [];
  };

  return Events;

})();

ProxyEventManager = (function() {
  function ProxyEventManager() {}

  ProxyEventManager.prototype.handle = function(myo, eventData) {
    var handler;
    this.initSession(myo, eventData);
    myo.session.messagesQueue.push(eventData);
    handler = this.getHandler(eventData.type);
    return handler.call(this, myo, eventData);
  };

  ProxyEventManager.prototype.initSession = function(myo, eventData) {
    if (!myo.session) {
      myo.session = new Session();
      return false;
    }
    return true;
  };

  ProxyEventManager.prototype.removeSession = function(myo) {
    if (myo.session) {
      myo.session.close();
    }
    return myo.session = null;
  };

  ProxyEventManager.prototype.getHandler = function(eventType) {
    return this[eventType] || this["default"];
  };

  ProxyEventManager.prototype.arm_recognized = function(myo, eventData) {
    myo.session.onArmRecognized(eventData.arm, eventData.x_direction, eventData.timestamp);
    return myo.trigger('arm_recognized', eventData);
  };

  ProxyEventManager.prototype.arm_lost = function(myo, eventData) {
    this.removeSession(myo);
    return myo.trigger('arm_lost', eventData);
  };

  ProxyEventManager.prototype.paired = function(myo, eventData) {
    return myo.trigger('paired', eventData);
  };

  ProxyEventManager.prototype.pose = function(myo, eventData) {
    myo.session.pose = eventData.pose;
    return myo.trigger('pose', eventData.pose);
  };

  ProxyEventManager.prototype.orientation = function(myo, eventData) {
    return myo.trigger('orientation', eventData);
  };

  ProxyEventManager.prototype.rssi = function(myo, eventData) {
    return myo.trigger('bluetooth_strength', eventData.rssi);
  };

  ProxyEventManager.prototype.connected = function(myo, eventData) {
    myo.session.onConnected(eventData.version, eventData.timestamp);
    return myo.trigger('connected', eventData);
  };

  ProxyEventManager.prototype.disconnected = function(myo, eventData) {
    this.removeSession(myo);
    return myo.trigger('disconnected', eventData);
  };

  ProxyEventManager.prototype["default"] = function(myo, eventData) {
    return console.log('Unhandled event:', eventData);
  };

  return ProxyEventManager;

})();

ExtendedProxyEventManager = (function(_super) {
  __extends(ExtendedProxyEventManager, _super);

  function ExtendedProxyEventManager() {
    return ExtendedProxyEventManager.__super__.constructor.apply(this, arguments);
  }

  ExtendedProxyEventManager.prototype.orientation = function(myo, eventData) {
    var accelerometerData, gyroscopeData, imuData, orientationData, state;
    state = myo.session.extra;
    orientationData = {
      x: eventData.orientation.x,
      y: eventData.orientation.y,
      z: eventData.orientation.z,
      w: eventData.orientation.w
    };
    gyroscopeData = {
      x: eventData.gyroscope[0],
      y: eventData.gyroscope[1],
      z: eventData.gyroscope[2]
    };
    accelerometerData = {
      x: eventData.accelerometer[0],
      y: eventData.accelerometer[1],
      z: eventData.accelerometer[2]
    };
    imuData = {
      gyroscope: gyroscopeData,
      accelerometer: accelerometerData,
      orientation: orientationData
    };
    state.lastOrientationData = orientationData;
    ExtendedProxyEventManager.__super__.orientation.call(this, orientationData);
    this.gyroscope(myo, gyroscopeData);
    this.accelerometer(myo, accelerometerData);
    return this.imu(myo, imuData);
  };

  ExtendedProxyEventManager.prototype.gyroscope = function(myo, eventData) {
    return myo.trigger('gyroscope', eventData);
  };

  ExtendedProxyEventManager.prototype.accelerometer = function(myo, eventData) {
    return myo.trigger('accelerometer', eventData);
  };

  ExtendedProxyEventManager.prototype.imu = function(myo, eventData) {
    return myo.trigger('imu', eventData);
  };

  return ExtendedProxyEventManager;

})(ProxyEventManager);

ExperimentalProxyEventManager = (function(_super) {
  __extends(ExperimentalProxyEventManager, _super);

  function ExperimentalProxyEventManager() {
    return ExperimentalProxyEventManager.__super__.constructor.apply(this, arguments);
  }

  ExperimentalProxyEventManager.prototype.initSession = function(myo) {
    var hadSession;
    hadSession = ExperimentalProxyEventManager.__super__.initSession.apply(this, arguments);
    if (!hadSession) {
      return _.extend(myo.session.extra, {
        wasRight: false,
        sensitivity: 20,
        lastIMU: null,
        doubleTap: {
          threshold: 0.9,
          time: [80, 300]
        },
        lastOrientationData: {
          x: 0,
          y: 0,
          z: 0,
          w: 0
        }
      });
    }
  };

  ExperimentalProxyEventManager.prototype.imu = function(myo, eventData) {
    console.log('store last imu', eventData);
    myo.session.extra.lastIMU = eventData;
    return ExperimentalProxyEventManager.__super__.imu.apply(this, arguments);
  };

  ExperimentalProxyEventManager.prototype.accelerometer = function(myo, eventData) {
    var delta, diff, doubleTapOptions, last, state, y, z;
    ExperimentalProxyEventManager.__super__.accelerometer.apply(this, arguments);
    state = myo.session.extra;
    if (!state.lastIMU) {
      return;
    }
    doubleTapOptions = state.doubleTap;
    last = state.lastIMU.accelerometer;
    y = Math.abs(eventData.y);
    z = Math.abs(eventData.z);
    delta = Math.abs(Math.abs(last.y) - y) + Math.abs(Math.abs(last.z) - z);
    if (delta > doubleTapOptions.threshold) {
      if (state.last_tap) {
        diff = new Date().getTime() - state.last_tap;
        if (diff > doubleTapOptions.time[0] && diff < doubleTapOptions.time[1]) {
          this.double_tap(myo, eventData);
        }
      }
      return state.last_tap = new Date().getTime();
    }
  };

  ExperimentalProxyEventManager.prototype.imu = function(myo, eventData) {
    var sensLeft, sensRight, state;
    ExperimentalProxyEventManager.__super__.imu.apply(this, arguments);
    eventData = eventData.orientation;
    state = myo.session.extra;
    sensRight = (20 + state.sensitivity) * -1;
    if (eventData.x < sensRight && !state.wasRight) {
      state.wasRight = true;
      return;
    }
    sensLeft = 80 + (state.sensitivity * 2);
    if (eventData.x > sensLeft && state.wasRight) {
      this.slap_left(myo, eventData);
      return state.wasRight = false;
    }
  };

  ExperimentalProxyEventManager.prototype.double_tap = function(myo, eventData) {
    myo.trigger('double_tap', eventData);
    return myo.zeroOrientation();
  };

  ExperimentalProxyEventManager.prototype.slap_left = function(myo, eventData) {
    return myo.trigger('slap_left', eventData);
  };

  return ExperimentalProxyEventManager;

})(ExtendedProxyEventManager);

_.extend(exports, {
  Events: Events,
  Subscription: Subscription,
  ProxyEventManager: ProxyEventManager,
  ExtendedProxyEventManager: ExtendedProxyEventManager,
  ExperimentalProxyEventManager: ExperimentalProxyEventManager
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy5jb2ZmZWUiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBQSxDQUFBO0FBQUEsSUFBQSwySEFBQTtFQUFBOztpU0FBQTs7QUFBQSxDQUVBLEdBQUksT0FBQSxDQUFRLFlBQVIsQ0FGSixDQUFBOztBQUFBO0FBTWUsRUFBQSxzQkFBRSxLQUFGLEdBQUE7QUFDWCxJQURZLElBQUMsQ0FBQSx3QkFBQSxRQUFNLElBQ25CLENBQUE7QUFBQSxJQUFBLElBQUMsQ0FBQSxLQUFELEdBQVMsRUFBVCxDQURXO0VBQUEsQ0FBYjs7QUFBQSx5QkFHQSxLQUFBLEdBQU8sU0FBQSxHQUFBO0FBQ0wsSUFBQSxJQUFHLElBQUMsQ0FBQSxLQUFLLENBQUMsTUFBUCxHQUFnQixJQUFDLENBQUEsS0FBcEI7YUFDRSxJQUFDLENBQUEsS0FBSyxDQUFDLE1BQVAsQ0FBYyxJQUFDLENBQUEsS0FBZixFQUFzQixJQUFDLENBQUEsS0FBSyxDQUFDLE1BQVAsR0FBZ0IsSUFBQyxDQUFBLEtBQXZDLEVBREY7S0FESztFQUFBLENBSFAsQ0FBQTs7QUFBQSx5QkFPQSxJQUFBLEdBQU0sU0FBQyxNQUFELEdBQUE7QUFDSixJQUFBLElBQUMsQ0FBQSxLQUFELENBQUEsQ0FBQSxDQUFBO0FBQ0EsV0FBTyxJQUFDLENBQUEsS0FBSyxDQUFDLElBQVAsQ0FBWSxNQUFaLENBQVAsQ0FGSTtFQUFBLENBUE4sQ0FBQTs7QUFBQSx5QkFXQSxZQUFBLEdBQWMsU0FBQyxNQUFELEdBQUE7O01BQUMsU0FBTztLQUNwQjtBQUFBLFdBQU8sSUFBQyxDQUFBLEtBQUssQ0FBQyxLQUFQLENBQWEsQ0FBYixFQUFnQixNQUFoQixDQUFQLENBRFk7RUFBQSxDQVhkLENBQUE7O3NCQUFBOztJQU5GLENBQUE7O0FBQUE7QUF5QmUsRUFBQSxpQkFBRSxpQkFBRixHQUFBO0FBQ1gsSUFEWSxJQUFDLENBQUEsb0JBQUEsaUJBQ2IsQ0FBQTtBQUFBLElBQUEsSUFBQyxDQUFBLElBQUQsR0FBUSxJQUFSLENBQUE7QUFBQSxJQUNBLElBQUMsQ0FBQSxhQUFELEdBQXFCLElBQUEsWUFBQSxDQUFhLElBQUMsQ0FBQSxpQkFBZCxDQURyQixDQUFBO0FBQUEsSUFFQSxJQUFDLENBQUEsR0FBRCxHQUFPLElBQUMsQ0FBQSxTQUFELEdBQWEsSUFBQyxDQUFBLE9BQUQsR0FBVyxJQUFDLENBQUEsa0JBQUQsR0FBc0IsSUFBQyxDQUFBLHNCQUFELEdBQTBCLElBRi9FLENBQUE7QUFBQSxJQUtBLElBQUMsQ0FBQSxLQUFELEdBQVMsRUFMVCxDQURXO0VBQUEsQ0FBYjs7QUFBQSxvQkFRQSxVQUFBLEdBQVksU0FBQSxHQUFBLENBUlosQ0FBQTs7QUFBQSxvQkFlQSxXQUFBLEdBQWEsU0FBQyxPQUFELEVBQVcsa0JBQVgsR0FBQTtBQUNYLElBRHFCLElBQUMsQ0FBQSxxQkFBQSxrQkFDdEIsQ0FBQTtXQUFBLElBQUMsQ0FBQSxPQUFELEdBQVcsT0FBTyxDQUFDLElBQVIsQ0FBYSxHQUFiLEVBREE7RUFBQSxDQWZiLENBQUE7O0FBQUEsb0JBa0JBLGVBQUEsR0FBaUIsU0FBRSxHQUFGLEVBQVEsU0FBUixFQUFvQixzQkFBcEIsR0FBQTtBQUE2QyxJQUE1QyxJQUFDLENBQUEsTUFBQSxHQUEyQyxDQUFBO0FBQUEsSUFBdEMsSUFBQyxDQUFBLFlBQUEsU0FBcUMsQ0FBQTtBQUFBLElBQTFCLElBQUMsQ0FBQSx5QkFBQSxzQkFBeUIsQ0FBN0M7RUFBQSxDQWxCakIsQ0FBQTs7QUFBQSxvQkFvQkEsS0FBQSxHQUFPLFNBQUEsR0FBQSxDQXBCUCxDQUFBOztpQkFBQTs7SUF6QkYsQ0FBQTs7QUFBQTtBQWtEZSxFQUFBLHNCQUFFLFFBQUYsRUFBYSxLQUFiLEVBQXFCLGdCQUFyQixHQUFBO0FBQXdDLElBQXZDLElBQUMsQ0FBQSxXQUFBLFFBQXNDLENBQUE7QUFBQSxJQUE1QixJQUFDLENBQUEsUUFBQSxLQUEyQixDQUFBO0FBQUEsSUFBcEIsSUFBQyxDQUFBLG1CQUFBLGdCQUFtQixDQUF4QztFQUFBLENBQWI7O0FBQUEseUJBRUEsTUFBQSxHQUFRLFNBQUEsR0FBQTtBQUNOLFFBQUEsSUFBQTtBQUFBLElBRE8sOERBQ1AsQ0FBQTtXQUFBLElBQUMsQ0FBQSxRQUFELGFBQVUsSUFBVixFQURNO0VBQUEsQ0FGUixDQUFBOztBQUFBLHlCQUtBLE9BQUEsR0FBUyxTQUFBLEdBQUE7V0FDUCxJQUFDLENBQUEsZ0JBQWdCLENBQUMsTUFBbEIsQ0FBeUIsSUFBQyxDQUFBLEtBQTFCLEVBQWlDLENBQWpDLEVBRE87RUFBQSxDQUxULENBQUE7O3NCQUFBOztJQWxERixDQUFBOztBQUFBO0FBNERlLEVBQUEsZ0JBQUEsR0FBQTtBQUNYLElBQUEsSUFBQyxDQUFBLE1BQUQsR0FBVSxFQUFWLENBRFc7RUFBQSxDQUFiOztBQUFBLG1CQUdBLEVBQUEsR0FBSSxTQUFDLFNBQUQsRUFBWSxRQUFaLEdBQUE7QUFDRixRQUFBLDhCQUFBO0FBQUEsSUFBQSxJQUFHLENBQUEsSUFBSyxDQUFBLE1BQU8sQ0FBQSxTQUFBLENBQWY7QUFDRSxNQUFBLElBQUMsQ0FBQSxNQUFPLENBQUEsU0FBQSxDQUFSLEdBQXFCLEVBQXJCLENBREY7S0FBQTtBQUFBLElBR0EsZ0JBQUEsR0FBbUIsSUFBQyxDQUFBLE1BQU8sQ0FBQSxTQUFBLENBSDNCLENBQUE7QUFBQSxJQUlBLFlBQUEsR0FBbUIsSUFBQSxZQUFBLENBQ2pCLFFBRGlCLEVBRWpCLGdCQUFnQixDQUFDLE1BRkEsRUFHakIsZ0JBSGlCLENBSm5CLENBQUE7QUFBQSxJQVNBLGdCQUFnQixDQUFDLElBQWpCLENBQXNCLFlBQXRCLENBVEEsQ0FBQTtBQVVBLFdBQU8sWUFBUCxDQVhFO0VBQUEsQ0FISixDQUFBOztBQUFBLG1CQWdCQSxPQUFBLEdBQVMsU0FBQSxHQUFBO0FBQ1AsUUFBQSw4REFBQTtBQUFBLElBRFEsMEJBQVcsOERBQ25CLENBQUE7QUFBQSxJQUFBLGdCQUFBLEdBQW1CLElBQUMsQ0FBQSxNQUFPLENBQUEsU0FBQSxDQUFSLElBQXNCLEVBQXpDLENBQUE7QUFBQSxJQUNBLEdBQUEsR0FBTSxnQkFBZ0IsQ0FBQyxNQUR2QixDQUFBO0FBR0E7V0FBTSxHQUFBLEVBQU4sR0FBQTtBQUNFLE1BQUEsWUFBQSxHQUFlLGdCQUFpQixDQUFBLEdBQUEsQ0FBaEMsQ0FBQTtBQUFBLG9CQUNBLFlBQVksQ0FBQyxNQUFiLHFCQUFvQixJQUFwQixFQURBLENBREY7SUFBQSxDQUFBO29CQUpPO0VBQUEsQ0FoQlQsQ0FBQTs7QUFBQSxtQkF3QkEsR0FBQSxHQUFLLFNBQUMsU0FBRCxHQUFBO1dBR0gsSUFBQyxDQUFBLE1BQU8sQ0FBQSxTQUFBLENBQVIsR0FBcUIsR0FIbEI7RUFBQSxDQXhCTCxDQUFBOztnQkFBQTs7SUE1REYsQ0FBQTs7QUFBQTtpQ0ErRkU7O0FBQUEsOEJBQUEsTUFBQSxHQUFRLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUNOLFFBQUEsT0FBQTtBQUFBLElBQUEsSUFBQyxDQUFBLFdBQUQsQ0FBYSxHQUFiLEVBQWtCLFNBQWxCLENBQUEsQ0FBQTtBQUFBLElBQ0EsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBMUIsQ0FBK0IsU0FBL0IsQ0FEQSxDQUFBO0FBQUEsSUFFQSxPQUFBLEdBQVUsSUFBQyxDQUFBLFVBQUQsQ0FBWSxTQUFTLENBQUMsSUFBdEIsQ0FGVixDQUFBO1dBR0EsT0FBTyxDQUFDLElBQVIsQ0FBYSxJQUFiLEVBQWdCLEdBQWhCLEVBQXFCLFNBQXJCLEVBSk07RUFBQSxDQUFSLENBQUE7O0FBQUEsOEJBTUEsV0FBQSxHQUFhLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUNYLElBQUEsSUFBRyxDQUFBLEdBQU8sQ0FBQyxPQUFYO0FBQ0UsTUFBQSxHQUFHLENBQUMsT0FBSixHQUFrQixJQUFBLE9BQUEsQ0FBQSxDQUFsQixDQUFBO0FBQ0EsYUFBTyxLQUFQLENBRkY7S0FBQTtBQUdBLFdBQU8sSUFBUCxDQUpXO0VBQUEsQ0FOYixDQUFBOztBQUFBLDhCQVlBLGFBQUEsR0FBZSxTQUFDLEdBQUQsR0FBQTtBQUNiLElBQUEsSUFBRyxHQUFHLENBQUMsT0FBUDtBQUNFLE1BQUEsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFaLENBQUEsQ0FBQSxDQURGO0tBQUE7V0FHQSxHQUFHLENBQUMsT0FBSixHQUFjLEtBSkQ7RUFBQSxDQVpmLENBQUE7O0FBQUEsOEJBa0JBLFVBQUEsR0FBWSxTQUFDLFNBQUQsR0FBQTtBQUNWLFdBQU8sSUFBRSxDQUFBLFNBQUEsQ0FBRixJQUFnQixJQUFDLENBQUMsU0FBRCxDQUF4QixDQURVO0VBQUEsQ0FsQlosQ0FBQTs7QUFBQSw4QkFzQkEsY0FBQSxHQUFnQixTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7QUFDZCxJQUFBLEdBQUcsQ0FBQyxPQUFPLENBQUMsZUFBWixDQUE0QixTQUFTLENBQUMsR0FBdEMsRUFBMkMsU0FBUyxDQUFDLFdBQXJELEVBQWtFLFNBQVMsQ0FBQyxTQUE1RSxDQUFBLENBQUE7V0FDQSxHQUFHLENBQUMsT0FBSixDQUFZLGdCQUFaLEVBQThCLFNBQTlCLEVBRmM7RUFBQSxDQXRCaEIsQ0FBQTs7QUFBQSw4QkEwQkEsUUFBQSxHQUFVLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUNSLElBQUEsSUFBQyxDQUFBLGFBQUQsQ0FBZSxHQUFmLENBQUEsQ0FBQTtXQUNBLEdBQUcsQ0FBQyxPQUFKLENBQVksVUFBWixFQUF3QixTQUF4QixFQUZRO0VBQUEsQ0ExQlYsQ0FBQTs7QUFBQSw4QkE4QkEsTUFBQSxHQUFRLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtXQUNOLEdBQUcsQ0FBQyxPQUFKLENBQVksUUFBWixFQUFzQixTQUF0QixFQURNO0VBQUEsQ0E5QlIsQ0FBQTs7QUFBQSw4QkFpQ0EsSUFBQSxHQUFNLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUNKLElBQUEsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFaLEdBQW1CLFNBQVMsQ0FBQyxJQUE3QixDQUFBO1dBQ0EsR0FBRyxDQUFDLE9BQUosQ0FBWSxNQUFaLEVBQW9CLFNBQVMsQ0FBQyxJQUE5QixFQUZJO0VBQUEsQ0FqQ04sQ0FBQTs7QUFBQSw4QkFxQ0EsV0FBQSxHQUFhLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtXQUNYLEdBQUcsQ0FBQyxPQUFKLENBQVksYUFBWixFQUEyQixTQUEzQixFQURXO0VBQUEsQ0FyQ2IsQ0FBQTs7QUFBQSw4QkF3Q0EsSUFBQSxHQUFNLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtXQUNKLEdBQUcsQ0FBQyxPQUFKLENBQVksb0JBQVosRUFBa0MsU0FBUyxDQUFDLElBQTVDLEVBREk7RUFBQSxDQXhDTixDQUFBOztBQUFBLDhCQTJDQSxTQUFBLEdBQVcsU0FBQyxHQUFELEVBQU0sU0FBTixHQUFBO0FBQ1QsSUFBQSxHQUFHLENBQUMsT0FBTyxDQUFDLFdBQVosQ0FBd0IsU0FBUyxDQUFDLE9BQWxDLEVBQTJDLFNBQVMsQ0FBQyxTQUFyRCxDQUFBLENBQUE7V0FDQSxHQUFHLENBQUMsT0FBSixDQUFZLFdBQVosRUFBeUIsU0FBekIsRUFGUztFQUFBLENBM0NYLENBQUE7O0FBQUEsOEJBK0NBLFlBQUEsR0FBYyxTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7QUFFWixJQUFBLElBQUMsQ0FBQSxhQUFELENBQWUsR0FBZixDQUFBLENBQUE7V0FDQSxHQUFHLENBQUMsT0FBSixDQUFZLGNBQVosRUFBNEIsU0FBNUIsRUFIWTtFQUFBLENBL0NkLENBQUE7O0FBQUEsOEJBb0RBLFVBQUEsR0FBUyxTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7V0FDUCxPQUFPLENBQUMsR0FBUixDQUFZLGtCQUFaLEVBQWdDLFNBQWhDLEVBRE87RUFBQSxDQXBEVCxDQUFBOzsyQkFBQTs7SUEvRkYsQ0FBQTs7QUFBQTtBQXdKRSw4Q0FBQSxDQUFBOzs7O0dBQUE7O0FBQUEsc0NBQUEsV0FBQSxHQUFhLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUdYLFFBQUEsaUVBQUE7QUFBQSxJQUFBLEtBQUEsR0FBUSxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQXBCLENBQUE7QUFBQSxJQUNBLGVBQUEsR0FBa0I7QUFBQSxNQUNoQixDQUFBLEVBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQURUO0FBQUEsTUFFaEIsQ0FBQSxFQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FGVDtBQUFBLE1BR2hCLENBQUEsRUFBRyxTQUFTLENBQUMsV0FBVyxDQUFDLENBSFQ7QUFBQSxNQUloQixDQUFBLEVBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUpUO0tBRGxCLENBQUE7QUFBQSxJQU9BLGFBQUEsR0FBZ0I7QUFBQSxNQUNkLENBQUEsRUFBRyxTQUFTLENBQUMsU0FBVSxDQUFBLENBQUEsQ0FEVDtBQUFBLE1BRWQsQ0FBQSxFQUFHLFNBQVMsQ0FBQyxTQUFVLENBQUEsQ0FBQSxDQUZUO0FBQUEsTUFHZCxDQUFBLEVBQUcsU0FBUyxDQUFDLFNBQVUsQ0FBQSxDQUFBLENBSFQ7S0FQaEIsQ0FBQTtBQUFBLElBWUEsaUJBQUEsR0FBb0I7QUFBQSxNQUNsQixDQUFBLEVBQUcsU0FBUyxDQUFDLGFBQWMsQ0FBQSxDQUFBLENBRFQ7QUFBQSxNQUVsQixDQUFBLEVBQUcsU0FBUyxDQUFDLGFBQWMsQ0FBQSxDQUFBLENBRlQ7QUFBQSxNQUdsQixDQUFBLEVBQUcsU0FBUyxDQUFDLGFBQWMsQ0FBQSxDQUFBLENBSFQ7S0FacEIsQ0FBQTtBQUFBLElBaUJBLE9BQUEsR0FBVTtBQUFBLE1BQ1IsU0FBQSxFQUFXLGFBREg7QUFBQSxNQUVSLGFBQUEsRUFBZSxpQkFGUDtBQUFBLE1BR1IsV0FBQSxFQUFhLGVBSEw7S0FqQlYsQ0FBQTtBQUFBLElBc0JBLEtBQUssQ0FBQyxtQkFBTixHQUE0QixlQXRCNUIsQ0FBQTtBQUFBLElBd0JBLDJEQUFNLGVBQU4sQ0F4QkEsQ0FBQTtBQUFBLElBeUJBLElBQUMsQ0FBQSxTQUFELENBQVcsR0FBWCxFQUFnQixhQUFoQixDQXpCQSxDQUFBO0FBQUEsSUEwQkEsSUFBQyxDQUFBLGFBQUQsQ0FBZSxHQUFmLEVBQW9CLGlCQUFwQixDQTFCQSxDQUFBO1dBMkJBLElBQUMsQ0FBQSxHQUFELENBQUssR0FBTCxFQUFVLE9BQVYsRUE5Qlc7RUFBQSxDQUFiLENBQUE7O0FBQUEsc0NBZ0NBLFNBQUEsR0FBVyxTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7V0FDVCxHQUFHLENBQUMsT0FBSixDQUFZLFdBQVosRUFBeUIsU0FBekIsRUFEUztFQUFBLENBaENYLENBQUE7O0FBQUEsc0NBbUNBLGFBQUEsR0FBZSxTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7V0FDYixHQUFHLENBQUMsT0FBSixDQUFZLGVBQVosRUFBNkIsU0FBN0IsRUFEYTtFQUFBLENBbkNmLENBQUE7O0FBQUEsc0NBc0NBLEdBQUEsR0FBSyxTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7V0FDSCxHQUFHLENBQUMsT0FBSixDQUFZLEtBQVosRUFBbUIsU0FBbkIsRUFERztFQUFBLENBdENMLENBQUE7O21DQUFBOztHQURzQyxrQkF2SnhDLENBQUE7O0FBQUE7QUFtTUUsa0RBQUEsQ0FBQTs7OztHQUFBOztBQUFBLDBDQUFBLFdBQUEsR0FBYSxTQUFDLEdBQUQsR0FBQTtBQUNYLFFBQUEsVUFBQTtBQUFBLElBQUEsVUFBQSxHQUFhLGdFQUFBLFNBQUEsQ0FBYixDQUFBO0FBRUEsSUFBQSxJQUFHLENBQUEsVUFBSDthQUNFLENBQUMsQ0FBQyxNQUFGLENBQVMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFyQixFQUE0QjtBQUFBLFFBQzFCLFFBQUEsRUFBVSxLQURnQjtBQUFBLFFBRTFCLFdBQUEsRUFBYSxFQUZhO0FBQUEsUUFHMUIsT0FBQSxFQUFTLElBSGlCO0FBQUEsUUFJMUIsU0FBQSxFQUFXO0FBQUEsVUFDVCxTQUFBLEVBQVcsR0FERjtBQUFBLFVBRVQsSUFBQSxFQUFNLENBQUMsRUFBRCxFQUFLLEdBQUwsQ0FGRztTQUplO0FBQUEsUUFRMUIsbUJBQUEsRUFBcUI7QUFBQSxVQUFDLENBQUEsRUFBRyxDQUFKO0FBQUEsVUFBTyxDQUFBLEVBQUcsQ0FBVjtBQUFBLFVBQWEsQ0FBQSxFQUFHLENBQWhCO0FBQUEsVUFBbUIsQ0FBQSxFQUFHLENBQXRCO1NBUks7T0FBNUIsRUFERjtLQUhXO0VBQUEsQ0FBYixDQUFBOztBQUFBLDBDQWVBLEdBQUEsR0FBSyxTQUFDLEdBQUQsRUFBTSxTQUFOLEdBQUE7QUFDSCxJQUFBLE9BQU8sQ0FBQyxHQUFSLENBQVksZ0JBQVosRUFBOEIsU0FBOUIsQ0FBQSxDQUFBO0FBQUEsSUFDQSxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFsQixHQUE0QixTQUQ1QixDQUFBO1dBRUEsd0RBQUEsU0FBQSxFQUhHO0VBQUEsQ0FmTCxDQUFBOztBQUFBLDBDQW9CQSxhQUFBLEdBQWUsU0FBQyxHQUFELEVBQU0sU0FBTixHQUFBO0FBR2IsUUFBQSxnREFBQTtBQUFBLElBQUEsa0VBQUEsU0FBQSxDQUFBLENBQUE7QUFBQSxJQUVBLEtBQUEsR0FBUSxHQUFHLENBQUMsT0FBTyxDQUFDLEtBRnBCLENBQUE7QUFJQSxJQUFBLElBQUcsQ0FBQSxLQUFTLENBQUMsT0FBYjtBQUNFLFlBQUEsQ0FERjtLQUpBO0FBQUEsSUFPQSxnQkFBQSxHQUFtQixLQUFLLENBQUMsU0FQekIsQ0FBQTtBQUFBLElBUUEsSUFBQSxHQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFSckIsQ0FBQTtBQUFBLElBVUEsQ0FBQSxHQUFJLElBQUksQ0FBQyxHQUFMLENBQVMsU0FBUyxDQUFDLENBQW5CLENBVkosQ0FBQTtBQUFBLElBV0EsQ0FBQSxHQUFJLElBQUksQ0FBQyxHQUFMLENBQVMsU0FBUyxDQUFDLENBQW5CLENBWEosQ0FBQTtBQUFBLElBWUEsS0FBQSxHQUFRLElBQUksQ0FBQyxHQUFMLENBQVMsSUFBSSxDQUFDLEdBQUwsQ0FBUyxJQUFJLENBQUMsQ0FBZCxDQUFBLEdBQW1CLENBQTVCLENBQUEsR0FBaUMsSUFBSSxDQUFDLEdBQUwsQ0FBUyxJQUFJLENBQUMsR0FBTCxDQUFTLElBQUksQ0FBQyxDQUFkLENBQUEsR0FBbUIsQ0FBNUIsQ0FaekMsQ0FBQTtBQWNBLElBQUEsSUFBRyxLQUFBLEdBQVEsZ0JBQWdCLENBQUMsU0FBNUI7QUFDRSxNQUFBLElBQUcsS0FBSyxDQUFDLFFBQVQ7QUFDRSxRQUFBLElBQUEsR0FBVyxJQUFBLElBQUEsQ0FBQSxDQUFNLENBQUMsT0FBUCxDQUFBLENBQUosR0FBdUIsS0FBSyxDQUFDLFFBQXBDLENBQUE7QUFFQSxRQUFBLElBQUcsSUFBQSxHQUFPLGdCQUFnQixDQUFDLElBQUssQ0FBQSxDQUFBLENBQTdCLElBQW9DLElBQUEsR0FBTyxnQkFBZ0IsQ0FBQyxJQUFLLENBQUEsQ0FBQSxDQUFwRTtBQUVFLFVBQUEsSUFBQyxDQUFBLFVBQUQsQ0FBWSxHQUFaLEVBQWlCLFNBQWpCLENBQUEsQ0FGRjtTQUhGO09BQUE7YUFPQSxLQUFLLENBQUMsUUFBTixHQUFxQixJQUFBLElBQUEsQ0FBQSxDQUFNLENBQUMsT0FBUCxDQUFBLEVBUnZCO0tBakJhO0VBQUEsQ0FwQmYsQ0FBQTs7QUFBQSwwQ0ErQ0EsR0FBQSxHQUFLLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUVILFFBQUEsMEJBQUE7QUFBQSxJQUFBLHdEQUFBLFNBQUEsQ0FBQSxDQUFBO0FBQUEsSUFDQSxTQUFBLEdBQVksU0FBUyxDQUFDLFdBRHRCLENBQUE7QUFBQSxJQUdBLEtBQUEsR0FBUSxHQUFHLENBQUMsT0FBTyxDQUFDLEtBSHBCLENBQUE7QUFBQSxJQUlBLFNBQUEsR0FBWSxDQUFDLEVBQUEsR0FBSyxLQUFLLENBQUMsV0FBWixDQUFBLEdBQTJCLENBQUEsQ0FKdkMsQ0FBQTtBQU1BLElBQUEsSUFBRyxTQUFTLENBQUMsQ0FBVixHQUFjLFNBQWQsSUFBNEIsQ0FBQSxLQUFTLENBQUMsUUFBekM7QUFDRSxNQUFBLEtBQUssQ0FBQyxRQUFOLEdBQWlCLElBQWpCLENBQUE7QUFDQSxZQUFBLENBRkY7S0FOQTtBQUFBLElBVUEsUUFBQSxHQUFXLEVBQUEsR0FBSyxDQUFDLEtBQUssQ0FBQyxXQUFOLEdBQW9CLENBQXJCLENBVmhCLENBQUE7QUFZQSxJQUFBLElBQUcsU0FBUyxDQUFDLENBQVYsR0FBYyxRQUFkLElBQTJCLEtBQUssQ0FBQyxRQUFwQztBQUVFLE1BQUEsSUFBQyxDQUFBLFNBQUQsQ0FBVyxHQUFYLEVBQWdCLFNBQWhCLENBQUEsQ0FBQTthQUNBLEtBQUssQ0FBQyxRQUFOLEdBQWlCLE1BSG5CO0tBZEc7RUFBQSxDQS9DTCxDQUFBOztBQUFBLDBDQWtFQSxVQUFBLEdBQVksU0FBQyxHQUFELEVBQU0sU0FBTixHQUFBO0FBQ1YsSUFBQSxHQUFHLENBQUMsT0FBSixDQUFZLFlBQVosRUFBMEIsU0FBMUIsQ0FBQSxDQUFBO1dBR0EsR0FBRyxDQUFDLGVBQUosQ0FBQSxFQUpVO0VBQUEsQ0FsRVosQ0FBQTs7QUFBQSwwQ0F3RUEsU0FBQSxHQUFXLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtXQUNULEdBQUcsQ0FBQyxPQUFKLENBQVksV0FBWixFQUF5QixTQUF6QixFQURTO0VBQUEsQ0F4RVgsQ0FBQTs7dUNBQUE7O0dBRDBDLDBCQWxNNUMsQ0FBQTs7QUFBQSxDQStRQyxDQUFDLE1BQUYsQ0FBUyxPQUFULEVBQWtCO0FBQUEsRUFDaEIsTUFBQSxFQUFRLE1BRFE7QUFBQSxFQUVoQixZQUFBLEVBQWMsWUFGRTtBQUFBLEVBR2hCLGlCQUFBLEVBQW1CLGlCQUhIO0FBQUEsRUFJaEIseUJBQUEsRUFBMkIseUJBSlg7QUFBQSxFQUtoQiw2QkFBQSxFQUErQiw2QkFMZjtDQUFsQixDQS9RQSxDQUFBIiwiZmlsZSI6ImV2ZW50cy5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiXG5cbl8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJylcblxuXG5jbGFzcyBNZXNzYWdlUXVldWVcbiAgY29uc3RydWN0b3I6IChAbGltaXQ9MTAwMCktPlxuICAgIEBxdWV1ZSA9IFtdXG5cbiAgcHVyZ2U6IC0+XG4gICAgaWYgQHF1ZXVlLmxlbmd0aCA+IEBsaW1pdFxuICAgICAgQHF1ZXVlLnNwbGljZShAbGltaXQsIEBxdWV1ZS5sZW5ndGggLSBAbGltaXQpXG5cbiAgcHVzaDogKG9iamVjdCkgLT5cbiAgICBAcHVyZ2UoKVxuICAgIHJldHVybiBAcXVldWUucHVzaChvYmplY3QpXG5cbiAgZ2V0TGFzdEl0ZW1zOiAobGVuZ3RoPTEwMCkgLT5cbiAgICByZXR1cm4gQHF1ZXVlLnNsaWNlKDAsIGxlbmd0aClcblxuXG5jbGFzcyBTZXNzaW9uXG4gICMgU2Vzc2lvbiBjb25zdHJ1Y3RvclxuICAjIEBwYXJhbSB7U3RyaW5nfSBhcm0ge2xlZnR8cmlnaHR9XG4gICMgQHBhcmFtIHtTdHJpbmd9IGRpcmVjdGlvbiAjIG5vdCBzdXJlIGFib3V0IHRoaXMgb25lXG4gIGNvbnN0cnVjdG9yOiAoQG1lc3NhZ2VRdWV1ZUxpbWl0KSAtPlxuICAgIEBwb3NlID0gbnVsbFxuICAgIEBtZXNzYWdlc1F1ZXVlID0gbmV3IE1lc3NhZ2VRdWV1ZShAbWVzc2FnZVF1ZXVlTGltaXQpXG4gICAgQGFybSA9IEBkaXJlY3Rpb24gPSBAdmVyc2lvbiA9IEBjb25uZWN0ZWRUaW1lc3RhbXAgPSBAYXJtUmVjb2duaXplZFRpbWVzdGFtcCA9IG51bGxcblxuICAgICMgdGhpcyBvYmplY3QgY2FuIGJlIHVzZWQgYnkgY3VzdG9tIGV2ZW50cyB0byBzdG9yZSBhZGRpdGlvbmFsIGRhdGFcbiAgICBAZXh0cmEgPSB7fVxuXG4gIGluaXRpYWxpemU6IC0+XG4gICAgIyBoZXJlIEkgd2FudCB0byBhZGQgYW4gaW5pdGlhbGl6YXRpb24gb2YgdGhlIHVzZXIgc2Vzc2lvbiBvbiB0aGUgYXJtYmFuZCxcbiAgICAjIHJlZ2lzdGVyaW5nIGNvbW1vbiBhY3Rpb25zIGp1c3QgdG8ga25vdyB0aGUgdXNlciBiZXR0ZXIgYW5kIGFkYXB0IHRvIGhpc1xuICAgICMgaGFiaXRzIGV2ZXJ5IHBlcnNvbiBoYXMgYSBkaWZmZXJlbnQgc3RyZW5ndGggd2hlbiBwZXJmb3JtaW5nIGRpZmZlcmVudFxuICAgICMgYWN0aW9ucywgcmVnaXN0ZXJpbmcgY29tbW9uZyBhY3Rpb25zIHdpbGwgbWFrZSBpdCBlYXNpZXIgdG8gYWRhcHRcbiAgICAjIGFjdGlvbnMgYmFzZWQgb24gdXNlcidzIHNlbnNpdGl2aXR5XG5cbiAgb25Db25uZWN0ZWQ6ICh2ZXJzaW9uLCBAY29ubmVjdGVkVGltZXN0YW1wKSAtPlxuICAgIEB2ZXJzaW9uID0gdmVyc2lvbi5qb2luKCcuJylcblxuICBvbkFybVJlY29nbml6ZWQ6IChAYXJtLCBAZGlyZWN0aW9uLCBAYXJtUmVjb2duaXplZFRpbWVzdGFtcCkgLT5cblxuICBjbG9zZTogLT5cbiAgICAjIGRvIHNvbWV0aGluZz8gZW1wdHkgdGhlIG1lc3NhZ2UgcXVldWU/XG5cblxuY2xhc3MgU3Vic2NyaXB0aW9uXG4gIGNvbnN0cnVjdG9yOiAoQGNhbGxiYWNrLCBAaW5kZXgsIEBzdWJzY3JpcHRpb25MaXN0KSAtPlxuXG4gIGludm9rZTogKGFyZ3MuLi4pLT5cbiAgICBAY2FsbGJhY2soYXJncy4uLilcblxuICBkaXNwb3NlOiAtPlxuICAgIEBzdWJzY3JpcHRpb25MaXN0LnNwbGljZShAaW5kZXgsIDApXG5cblxuY2xhc3MgRXZlbnRzXG4gIGNvbnN0cnVjdG9yOiAtPlxuICAgIEBldmVudHMgPSB7fVxuXG4gIG9uOiAoZXZlbnROYW1lLCBsaXN0ZW5lcikgLT5cbiAgICBpZiBub3QgQGV2ZW50c1tldmVudE5hbWVdXG4gICAgICBAZXZlbnRzW2V2ZW50TmFtZV0gPSBbXSAgIyBuZXcgc3Vic2NyaXB0aW9uIGxpc3QgZm9yIHRoaXMgbmV3IGV2ZW50XG5cbiAgICBzdWJzY3JpcHRpb25MaXN0ID0gQGV2ZW50c1tldmVudE5hbWVdXG4gICAgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbihcbiAgICAgIGxpc3RlbmVyLFxuICAgICAgc3Vic2NyaXB0aW9uTGlzdC5sZW5ndGgsXG4gICAgICBzdWJzY3JpcHRpb25MaXN0XG4gICAgKVxuICAgIHN1YnNjcmlwdGlvbkxpc3QucHVzaChzdWJzY3JpcHRpb24pXG4gICAgcmV0dXJuIHN1YnNjcmlwdGlvblxuXG4gIHRyaWdnZXI6IChldmVudE5hbWUsIGFyZ3MuLi4pIC0+XG4gICAgc3Vic2NyaXB0aW9uTGlzdCA9IEBldmVudHNbZXZlbnROYW1lXSBvciBbXVxuICAgIGxlbiA9IHN1YnNjcmlwdGlvbkxpc3QubGVuZ3RoXG5cbiAgICB3aGlsZSBsZW4tLVxuICAgICAgc3Vic2NyaXB0aW9uID0gc3Vic2NyaXB0aW9uTGlzdFtsZW5dXG4gICAgICBzdWJzY3JpcHRpb24uaW52b2tlKGFyZ3MuLi4pXG5cbiAgb2ZmOiAoZXZlbnROYW1lKSAtPlxuICAgICMgdGhpcyBjYW4gYmUgdXNlZCB0byByZW1vdmUgYWxsIHN1YnNjcmlwdGlvbnMgdG8gYSBzcGVjaWZpYyBldmVudCwgdG9cbiAgICAjIGRpc3Bvc2Ugc2luZ2xlIHN1YnNjcmlwdGlvbiB1c2UgdGhlIGRpc3Bvc2UgbWV0aG9kIG9uIHRoZW1cbiAgICBAZXZlbnRzW2V2ZW50TmFtZV0gPSBbXVxuXG5cbmNsYXNzIFByb3h5RXZlbnRNYW5hZ2VyXG4gICMgUHJlcGFyZXMgZXZlbnQgYW5kIGV2ZW50IGRhdGEgdG8gYmUgcHJveGllZCB0byB0aGUgbXlvIGluc3RhbmNlXG4gICMgSXQncyBhbHNvIHJlc3BvbnNpYmxlIHRvIGNyZWF0ZSBzZXNzaW9ucyBhbmQgdXBkYXRlIHRoZW0sIG9uIG15byBpbnN0YW5jZXNcbiAgIyBCeSBpbmhlcml0aW5nIGZyb20gdGhpcyBjbGFzcywgaXQgaXMgcG9zc2libGUgdG8gZXh0ZW5kIHRoZSBsaXN0IG9mIGV2ZW50c1xuICAjIGEgbXlvIGNhbiByZWNvZ25pemVcbiAgaGFuZGxlOiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgQGluaXRTZXNzaW9uKG15bywgZXZlbnREYXRhKVxuICAgIG15by5zZXNzaW9uLm1lc3NhZ2VzUXVldWUucHVzaChldmVudERhdGEpXG4gICAgaGFuZGxlciA9IEBnZXRIYW5kbGVyKGV2ZW50RGF0YS50eXBlKVxuICAgIGhhbmRsZXIuY2FsbChALCBteW8sIGV2ZW50RGF0YSlcblxuICBpbml0U2Vzc2lvbjogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIGlmIG5vdCBteW8uc2Vzc2lvblxuICAgICAgbXlvLnNlc3Npb24gPSBuZXcgU2Vzc2lvbigpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICByZXR1cm4gdHJ1ZVxuXG4gIHJlbW92ZVNlc3Npb246IChteW8pIC0+XG4gICAgaWYgbXlvLnNlc3Npb25cbiAgICAgIG15by5zZXNzaW9uLmNsb3NlKClcblxuICAgIG15by5zZXNzaW9uID0gbnVsbFxuXG4gIGdldEhhbmRsZXI6IChldmVudFR5cGUpIC0+XG4gICAgcmV0dXJuIEBbZXZlbnRUeXBlXSBvciBALmRlZmF1bHRcblxuICAjIGhhbmRsZXJzXG4gIGFybV9yZWNvZ25pemVkOiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgbXlvLnNlc3Npb24ub25Bcm1SZWNvZ25pemVkKGV2ZW50RGF0YS5hcm0sIGV2ZW50RGF0YS54X2RpcmVjdGlvbiwgZXZlbnREYXRhLnRpbWVzdGFtcClcbiAgICBteW8udHJpZ2dlcignYXJtX3JlY29nbml6ZWQnLCBldmVudERhdGEpXG5cbiAgYXJtX2xvc3Q6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBAcmVtb3ZlU2Vzc2lvbihteW8pXG4gICAgbXlvLnRyaWdnZXIoJ2FybV9sb3N0JywgZXZlbnREYXRhKVxuXG4gIHBhaXJlZDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by50cmlnZ2VyKCdwYWlyZWQnLCBldmVudERhdGEpXG5cbiAgcG9zZTogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by5zZXNzaW9uLnBvc2UgPSBldmVudERhdGEucG9zZVxuICAgIG15by50cmlnZ2VyKCdwb3NlJywgZXZlbnREYXRhLnBvc2UpXG5cbiAgb3JpZW50YXRpb246IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignb3JpZW50YXRpb24nLCBldmVudERhdGEpXG5cbiAgcnNzaTogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by50cmlnZ2VyKCdibHVldG9vdGhfc3RyZW5ndGgnLCBldmVudERhdGEucnNzaSlcblxuICBjb25uZWN0ZWQ6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8uc2Vzc2lvbi5vbkNvbm5lY3RlZChldmVudERhdGEudmVyc2lvbiwgZXZlbnREYXRhLnRpbWVzdGFtcClcbiAgICBteW8udHJpZ2dlcignY29ubmVjdGVkJywgZXZlbnREYXRhKVxuXG4gIGRpc2Nvbm5lY3RlZDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgICMgZGVzdHJveSBteW8gaW5zdGFuY2U/XG4gICAgQHJlbW92ZVNlc3Npb24obXlvKVxuICAgIG15by50cmlnZ2VyKCdkaXNjb25uZWN0ZWQnLCBldmVudERhdGEpXG5cbiAgZGVmYXVsdDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIGNvbnNvbGUubG9nKCdVbmhhbmRsZWQgZXZlbnQ6JywgZXZlbnREYXRhKVxuXG5cbmNsYXNzIEV4dGVuZGVkUHJveHlFdmVudE1hbmFnZXIgZXh0ZW5kcyBQcm94eUV2ZW50TWFuYWdlclxuICBvcmllbnRhdGlvbjogKG15bywgZXZlbnREYXRhKSAtPlxuICAgICMgY29tcGxldGVseSBvdmVycmlkZXMgcGFyZW50J3Mgb3JpZW50YXRpb24gbWV0aG9kXG4gICAgIyBhZGQgYW4gb2Zmc2V0IHRvIHRoZSBvcmllbnRhdGlvbiBkYXRhP1xuICAgIHN0YXRlID0gbXlvLnNlc3Npb24uZXh0cmFcbiAgICBvcmllbnRhdGlvbkRhdGEgPSB7XG4gICAgICB4OiBldmVudERhdGEub3JpZW50YXRpb24ueCMgLSBzdGF0ZS5vcmllbnRhdGlvbk9mZnNldC54XG4gICAgICB5OiBldmVudERhdGEub3JpZW50YXRpb24ueSMgLSBzdGF0ZS5vcmllbnRhdGlvbk9mZnNldC55XG4gICAgICB6OiBldmVudERhdGEub3JpZW50YXRpb24ueiMgLSBzdGF0ZS5vcmllbnRhdGlvbk9mZnNldC56XG4gICAgICB3OiBldmVudERhdGEub3JpZW50YXRpb24udyMgLSBzdGF0ZS5vcmllbnRhdGlvbk9mZnNldC53XG4gICAgfVxuICAgIGd5cm9zY29wZURhdGEgPSB7XG4gICAgICB4OiBldmVudERhdGEuZ3lyb3Njb3BlWzBdXG4gICAgICB5OiBldmVudERhdGEuZ3lyb3Njb3BlWzFdXG4gICAgICB6OiBldmVudERhdGEuZ3lyb3Njb3BlWzJdXG4gICAgfVxuICAgIGFjY2VsZXJvbWV0ZXJEYXRhID0ge1xuICAgICAgeDogZXZlbnREYXRhLmFjY2VsZXJvbWV0ZXJbMF1cbiAgICAgIHk6IGV2ZW50RGF0YS5hY2NlbGVyb21ldGVyWzFdXG4gICAgICB6OiBldmVudERhdGEuYWNjZWxlcm9tZXRlclsyXVxuICAgIH1cbiAgICBpbXVEYXRhID0ge1xuICAgICAgZ3lyb3Njb3BlOiBneXJvc2NvcGVEYXRhXG4gICAgICBhY2NlbGVyb21ldGVyOiBhY2NlbGVyb21ldGVyRGF0YVxuICAgICAgb3JpZW50YXRpb246IG9yaWVudGF0aW9uRGF0YVxuICAgIH1cbiAgICBzdGF0ZS5sYXN0T3JpZW50YXRpb25EYXRhID0gb3JpZW50YXRpb25EYXRhXG5cbiAgICBzdXBlcihvcmllbnRhdGlvbkRhdGEpXG4gICAgQGd5cm9zY29wZShteW8sIGd5cm9zY29wZURhdGEpXG4gICAgQGFjY2VsZXJvbWV0ZXIobXlvLCBhY2NlbGVyb21ldGVyRGF0YSlcbiAgICBAaW11KG15bywgaW11RGF0YSlcblxuICBneXJvc2NvcGU6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignZ3lyb3Njb3BlJywgZXZlbnREYXRhKVxuXG4gIGFjY2VsZXJvbWV0ZXI6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignYWNjZWxlcm9tZXRlcicsIGV2ZW50RGF0YSlcblxuICBpbXU6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignaW11JywgZXZlbnREYXRhKVxuXG5cbmNsYXNzIEV4cGVyaW1lbnRhbFByb3h5RXZlbnRNYW5hZ2VyIGV4dGVuZHMgRXh0ZW5kZWRQcm94eUV2ZW50TWFuYWdlclxuICBpbml0U2Vzc2lvbjogKG15bykgLT5cbiAgICBoYWRTZXNzaW9uID0gc3VwZXJcblxuICAgIGlmIG5vdCBoYWRTZXNzaW9uXG4gICAgICBfLmV4dGVuZChteW8uc2Vzc2lvbi5leHRyYSwge1xuICAgICAgICB3YXNSaWdodDogZmFsc2VcbiAgICAgICAgc2Vuc2l0aXZpdHk6IDIwXG4gICAgICAgIGxhc3RJTVU6IG51bGxcbiAgICAgICAgZG91YmxlVGFwOiB7XG4gICAgICAgICAgdGhyZXNob2xkOiAwLjlcbiAgICAgICAgICB0aW1lOiBbODAsIDMwMF1cbiAgICAgICAgfVxuICAgICAgICBsYXN0T3JpZW50YXRpb25EYXRhOiB7eDogMCwgeTogMCwgejogMCwgdzogMH1cbiAgICAgIH0pXG5cbiAgaW11OiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgY29uc29sZS5sb2coJ3N0b3JlIGxhc3QgaW11JywgZXZlbnREYXRhKVxuICAgIG15by5zZXNzaW9uLmV4dHJhLmxhc3RJTVUgPSBldmVudERhdGFcbiAgICBzdXBlclxuXG4gIGFjY2VsZXJvbWV0ZXI6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICAjIGFkZCBkb3VibGVfdGFwIGV2ZW50XG4gICAgIyBhbGwgcmlnaHRzIGZvciB0aGlzIGV2ZW50IGdvIHRvIHN0b2xrc2RvcmYgKCBodHRwczovL2dpdGh1Yi5jb20vc3RvbGtzZG9yZi9teW8uanMuZ2l0IClcbiAgICBzdXBlclxuXG4gICAgc3RhdGUgPSBteW8uc2Vzc2lvbi5leHRyYVxuXG4gICAgaWYgbm90IHN0YXRlLmxhc3RJTVVcbiAgICAgIHJldHVyblxuXG4gICAgZG91YmxlVGFwT3B0aW9ucyA9IHN0YXRlLmRvdWJsZVRhcFxuICAgIGxhc3QgPSBzdGF0ZS5sYXN0SU1VLmFjY2VsZXJvbWV0ZXJcblxuICAgIHkgPSBNYXRoLmFicyhldmVudERhdGEueSlcbiAgICB6ID0gTWF0aC5hYnMoZXZlbnREYXRhLnopXG4gICAgZGVsdGEgPSBNYXRoLmFicyhNYXRoLmFicyhsYXN0LnkpIC0geSkgKyBNYXRoLmFicyhNYXRoLmFicyhsYXN0LnopIC0geilcblxuICAgIGlmIGRlbHRhID4gZG91YmxlVGFwT3B0aW9ucy50aHJlc2hvbGRcbiAgICAgIGlmIHN0YXRlLmxhc3RfdGFwXG4gICAgICAgIGRpZmYgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHN0YXRlLmxhc3RfdGFwXG5cbiAgICAgICAgaWYgZGlmZiA+IGRvdWJsZVRhcE9wdGlvbnMudGltZVswXSBhbmQgZGlmZiA8IGRvdWJsZVRhcE9wdGlvbnMudGltZVsxXVxuICAgICAgICAgICMgdHJpZ2dlciBkb3VibGUgdGFwIGV2ZW50XG4gICAgICAgICAgQGRvdWJsZV90YXAobXlvLCBldmVudERhdGEpXG5cbiAgICAgIHN0YXRlLmxhc3RfdGFwID0gbmV3IERhdGUoKS5nZXRUaW1lKClcblxuICBpbXU6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICAjIGFkZCBzbGFwX2xlZnQgZXZlbnRcbiAgICBzdXBlclxuICAgIGV2ZW50RGF0YSA9IGV2ZW50RGF0YS5vcmllbnRhdGlvblxuXG4gICAgc3RhdGUgPSBteW8uc2Vzc2lvbi5leHRyYVxuICAgIHNlbnNSaWdodCA9ICgyMCArIHN0YXRlLnNlbnNpdGl2aXR5KSAqIC0xXG5cbiAgICBpZiBldmVudERhdGEueCA8IHNlbnNSaWdodCBhbmQgbm90IHN0YXRlLndhc1JpZ2h0XG4gICAgICBzdGF0ZS53YXNSaWdodCA9IHRydWVcbiAgICAgIHJldHVyblxuXG4gICAgc2Vuc0xlZnQgPSA4MCArIChzdGF0ZS5zZW5zaXRpdml0eSAqIDIpXG5cbiAgICBpZiBldmVudERhdGEueCA+IHNlbnNMZWZ0IGFuZCBzdGF0ZS53YXNSaWdodFxuICAgICAgIyB0cmlnZ2VyIHNsYXAgbGVmdCBldmVudFxuICAgICAgQHNsYXBfbGVmdChteW8sIGV2ZW50RGF0YSlcbiAgICAgIHN0YXRlLndhc1JpZ2h0ID0gZmFsc2VcblxuICBkb3VibGVfdGFwOiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgbXlvLnRyaWdnZXIoJ2RvdWJsZV90YXAnLCBldmVudERhdGEpXG5cbiAgICAjIGFsc28gcmVzZXQgbXlvJ3Mgb3JpZW50YXRpb24gP1xuICAgIG15by56ZXJvT3JpZW50YXRpb24oKVxuXG4gIHNsYXBfbGVmdDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by50cmlnZ2VyKCdzbGFwX2xlZnQnLCBldmVudERhdGEpXG5cblxuXy5leHRlbmQoZXhwb3J0cywge1xuICBFdmVudHM6IEV2ZW50c1xuICBTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvblxuICBQcm94eUV2ZW50TWFuYWdlcjogUHJveHlFdmVudE1hbmFnZXJcbiAgRXh0ZW5kZWRQcm94eUV2ZW50TWFuYWdlcjogRXh0ZW5kZWRQcm94eUV2ZW50TWFuYWdlclxuICBFeHBlcmltZW50YWxQcm94eUV2ZW50TWFuYWdlcjogRXhwZXJpbWVudGFsUHJveHlFdmVudE1hbmFnZXJcbn0pXG4iXX0=