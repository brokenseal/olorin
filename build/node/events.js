"use strict";
var Events, ExperimentalProxyEventManager, ExtendedProxyEventManager, MessageQueue, ProxyEventManager, Session, Subscription, _,
  __slice = [].slice,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

_ = require('underscore');

MessageQueue = (function() {
  function MessageQueue(limit) {
    this.limit = limit != null ? limit : 1000;
    this.queue = [];
  }

  MessageQueue.prototype.purge = function() {
    if (this.queue.length > this.limit) {
      return this.queue.splice(this.limit, this.queue.length - this.limit);
    }
  };

  MessageQueue.prototype.push = function(object) {
    this.purge();
    return this.queue.push(object);
  };

  MessageQueue.prototype.getLastItems = function(length) {
    if (length == null) {
      length = 100;
    }
    return this.queue.slice(0, length);
  };

  return MessageQueue;

})();

Session = (function() {
  function Session(messageQueueLimit) {
    this.messageQueueLimit = messageQueueLimit;
    this.pose = null;
    this.messagesQueue = new MessageQueue(this.messageQueueLimit);
    this.arm = this.direction = this.version = this.connectedTimestamp = this.armRecognizedTimestamp = null;
    this.extra = {};
  }

  Session.prototype.initialize = function() {};

  Session.prototype.onConnected = function(version, connectedTimestamp) {
    this.connectedTimestamp = connectedTimestamp;
    return this.version = version.join('.');
  };

  Session.prototype.onArmRecognized = function(arm, direction, armRecognizedTimestamp) {
    this.arm = arm;
    this.direction = direction;
    this.armRecognizedTimestamp = armRecognizedTimestamp;
  };

  Session.prototype.close = function() {};

  return Session;

})();

Subscription = (function() {
  function Subscription(callback, index, subscriptionList) {
    this.callback = callback;
    this.index = index;
    this.subscriptionList = subscriptionList;
  }

  Subscription.prototype.invoke = function() {
    var args;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return this.callback.apply(this, args);
  };

  Subscription.prototype.dispose = function() {
    return this.subscriptionList.splice(this.index, 0);
  };

  return Subscription;

})();

Events = (function() {
  function Events() {
    this.events = {};
  }

  Events.prototype.on = function(eventName, listener) {
    var subscription, subscriptionList;
    if (!this.events[eventName]) {
      this.events[eventName] = [];
    }
    subscriptionList = this.events[eventName];
    subscription = new Subscription(listener, subscriptionList.length, subscriptionList);
    subscriptionList.push(subscription);
    return subscription;
  };

  Events.prototype.trigger = function() {
    var args, eventName, len, subscription, subscriptionList, _results;
    eventName = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    subscriptionList = this.events[eventName] || [];
    len = subscriptionList.length;
    _results = [];
    while (len--) {
      subscription = subscriptionList[len];
      _results.push(subscription.invoke.apply(subscription, args));
    }
    return _results;
  };

  Events.prototype.off = function(eventName) {
    return this.events[eventName] = [];
  };

  return Events;

})();

ProxyEventManager = (function() {
  function ProxyEventManager() {}

  ProxyEventManager.prototype.handle = function(myo, eventData) {
    var handler;
    this.initSession(myo, eventData);
    myo.session.messagesQueue.push(eventData);
    handler = this.getHandler(eventData.type);
    return handler.call(this, myo, eventData);
  };

  ProxyEventManager.prototype.initSession = function(myo, eventData) {
    if (!myo.session) {
      myo.session = new Session();
      return false;
    }
    return true;
  };

  ProxyEventManager.prototype.removeSession = function(myo) {
    if (myo.session) {
      myo.session.close();
    }
    return myo.session = null;
  };

  ProxyEventManager.prototype.getHandler = function(eventType) {
    return this[eventType] || this["default"];
  };

  ProxyEventManager.prototype.arm_recognized = function(myo, eventData) {
    myo.session.onArmRecognized(eventData.arm, eventData.x_direction, eventData.timestamp);
    return myo.trigger('arm_recognized', eventData);
  };

  ProxyEventManager.prototype.arm_lost = function(myo, eventData) {
    this.removeSession(myo);
    return myo.trigger('arm_lost', eventData);
  };

  ProxyEventManager.prototype.paired = function(myo, eventData) {
    return myo.trigger('paired', eventData);
  };

  ProxyEventManager.prototype.pose = function(myo, eventData) {
    myo.session.pose = eventData.pose;
    return myo.trigger('pose', eventData.pose);
  };

  ProxyEventManager.prototype.orientation = function(myo, eventData) {
    return myo.trigger('orientation', eventData);
  };

  ProxyEventManager.prototype.rssi = function(myo, eventData) {
    return myo.trigger('bluetooth_strength', eventData.rssi);
  };

  ProxyEventManager.prototype.connected = function(myo, eventData) {
    myo.session.onConnected(eventData.version, eventData.timestamp);
    return myo.trigger('connected', eventData);
  };

  ProxyEventManager.prototype.disconnected = function(myo, eventData) {
    this.removeSession(myo);
    return myo.trigger('disconnected', eventData);
  };

  ProxyEventManager.prototype["default"] = function(myo, eventData) {
    return console.log('Unhandled event:', eventData);
  };

  return ProxyEventManager;

})();

ExtendedProxyEventManager = (function(_super) {
  __extends(ExtendedProxyEventManager, _super);

  function ExtendedProxyEventManager() {
    return ExtendedProxyEventManager.__super__.constructor.apply(this, arguments);
  }

  ExtendedProxyEventManager.prototype.orientation = function(myo, eventData) {
    var accelerometerData, gyroscopeData, imuData, orientationData, state;
    state = myo.session.extra;
    orientationData = {
      x: eventData.orientation.x - state.zeroOrientationOffset.x,
      y: eventData.orientation.y - state.zeroOrientationOffset.y,
      z: eventData.orientation.z - state.zeroOrientationOffset.z,
      w: eventData.orientation.w - state.zeroOrientationOffset.w
    };
    gyroscopeData = {
      x: eventData.gyroscope[0],
      y: eventData.gyroscope[1],
      z: eventData.gyroscope[2]
    };
    accelerometerData = {
      x: eventData.accelerometer[0],
      y: eventData.accelerometer[1],
      z: eventData.accelerometer[2]
    };
    imuData = {
      gyroscope: gyroscopeData,
      accelerometer: accelerometerData,
      orientation: orientationData
    };
    state.lastOrientationData = orientationData;
    ExtendedProxyEventManager.__super__.orientation.call(this, myo, orientationData);
    this.gyroscope(myo, gyroscopeData);
    this.accelerometer(myo, accelerometerData);
    return this.imu(myo, imuData);
  };

  ExtendedProxyEventManager.prototype.gyroscope = function(myo, eventData) {
    return myo.trigger('gyroscope', eventData);
  };

  ExtendedProxyEventManager.prototype.accelerometer = function(myo, eventData) {
    return myo.trigger('accelerometer', eventData);
  };

  ExtendedProxyEventManager.prototype.imu = function(myo, eventData) {
    return myo.trigger('imu', eventData);
  };

  return ExtendedProxyEventManager;

})(ProxyEventManager);

ExperimentalProxyEventManager = (function(_super) {
  __extends(ExperimentalProxyEventManager, _super);

  function ExperimentalProxyEventManager() {
    return ExperimentalProxyEventManager.__super__.constructor.apply(this, arguments);
  }

  ExperimentalProxyEventManager.prototype.initSession = function(myo) {
    var hadSession;
    hadSession = ExperimentalProxyEventManager.__super__.initSession.apply(this, arguments);
    if (!hadSession) {
      return _.extend(myo.session.extra, {
        wasRight: false,
        sensitivity: 20,
        lastIMU: null,
        doubleTap: {
          threshold: 0.9,
          time: [80, 300]
        },
        zeroOrientationOffset: {
          x: 0,
          y: 0,
          z: 0,
          w: 0
        }
      });
    }
  };

  ExperimentalProxyEventManager.prototype.accelerometer = function(myo, eventData) {
    var delta, diff, doubleTapOptions, last, state, y, z;
    ExperimentalProxyEventManager.__super__.accelerometer.apply(this, arguments);
    state = myo.session.extra;
    if (!state.lastIMU) {
      return;
    }
    doubleTapOptions = state.doubleTap;
    last = state.lastIMU.accelerometer;
    y = Math.abs(eventData.y);
    z = Math.abs(eventData.z);
    delta = Math.abs(Math.abs(last.y) - y) + Math.abs(Math.abs(last.z) - z);
    if (delta > doubleTapOptions.threshold) {
      if (state.last_tap) {
        diff = new Date().getTime() - state.last_tap;
        if (diff > doubleTapOptions.time[0] && diff < doubleTapOptions.time[1]) {
          this.double_tap(myo, eventData);
        }
      }
      return state.last_tap = new Date().getTime();
    }
  };

  ExperimentalProxyEventManager.prototype.imu = function(myo, eventData) {
    var sensLeft, sensRight, state;
    myo.session.extra.lastIMU = eventData;
    ExperimentalProxyEventManager.__super__.imu.apply(this, arguments);
    eventData = eventData.orientation;
    state = myo.session.extra;
    sensRight = (20 + state.sensitivity) * -1;
    if (eventData.x < sensRight && !state.wasRight) {
      state.wasRight = true;
      return;
    }
    sensLeft = 80 + (state.sensitivity * 2);
    if (eventData.x > sensLeft && state.wasRight) {
      this.slap_left(myo, eventData);
      return state.wasRight = false;
    }
  };

  ExperimentalProxyEventManager.prototype.slap_left = function(myo, eventData) {
    return myo.trigger('slap_left', eventData);
  };

  ExperimentalProxyEventManager.prototype.double_tap = function(myo, eventData) {
    myo.trigger('double_tap', eventData);
    return myo.zeroOrientation();
  };

  return ExperimentalProxyEventManager;

})(ExtendedProxyEventManager);

_.extend(exports, {
  Events: Events,
  Subscription: Subscription,
  ProxyEventManager: ProxyEventManager,
  ExtendedProxyEventManager: ExtendedProxyEventManager,
  ExperimentalProxyEventManager: ExperimentalProxyEventManager
});

//# sourceMappingURL=data:application/json;base64,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QUMsQ0FBQSxTQUFELENBQVcsR0FBWCxFQUFnQixTQUFoQixDQUFBLENBQUE7YUFDQSxLQUFLLENBQUMsUUFBTixHQUFpQixNQUhuQjtLQWZHO0VBQUEsQ0ExQ0wsQ0FBQTs7QUFBQSwwQ0E4REEsU0FBQSxHQUFXLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtXQUNULEdBQUcsQ0FBQyxPQUFKLENBQVksV0FBWixFQUF5QixTQUF6QixFQURTO0VBQUEsQ0E5RFgsQ0FBQTs7QUFBQSwwQ0FpRUEsVUFBQSxHQUFZLFNBQUMsR0FBRCxFQUFNLFNBQU4sR0FBQTtBQUNWLElBQUEsR0FBRyxDQUFDLE9BQUosQ0FBWSxZQUFaLEVBQTBCLFNBQTFCLENBQUEsQ0FBQTtXQUdBLEdBQUcsQ0FBQyxlQUFKLENBQUEsRUFKVTtFQUFBLENBakVaLENBQUE7O3VDQUFBOztHQUQwQywwQkFsTTVDLENBQUE7O0FBQUEsQ0EyUUMsQ0FBQyxNQUFGLENBQVMsT0FBVCxFQUFrQjtBQUFBLEVBQ2hCLE1BQUEsRUFBUSxNQURRO0FBQUEsRUFFaEIsWUFBQSxFQUFjLFlBRkU7QUFBQSxFQUdoQixpQkFBQSxFQUFtQixpQkFISDtBQUFBLEVBSWhCLHlCQUFBLEVBQTJCLHlCQUpYO0FBQUEsRUFLaEIsNkJBQUEsRUFBK0IsNkJBTGY7Q0FBbEIsQ0EzUUEsQ0FBQSIsImZpbGUiOiJldmVudHMuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIlxuXG5fID0gcmVxdWlyZSgndW5kZXJzY29yZScpXG5cblxuY2xhc3MgTWVzc2FnZVF1ZXVlXG4gIGNvbnN0cnVjdG9yOiAoQGxpbWl0PTEwMDApLT5cbiAgICBAcXVldWUgPSBbXVxuXG4gIHB1cmdlOiAtPlxuICAgIGlmIEBxdWV1ZS5sZW5ndGggPiBAbGltaXRcbiAgICAgIEBxdWV1ZS5zcGxpY2UoQGxpbWl0LCBAcXVldWUubGVuZ3RoIC0gQGxpbWl0KVxuXG4gIHB1c2g6IChvYmplY3QpIC0+XG4gICAgQHB1cmdlKClcbiAgICByZXR1cm4gQHF1ZXVlLnB1c2gob2JqZWN0KVxuXG4gIGdldExhc3RJdGVtczogKGxlbmd0aD0xMDApIC0+XG4gICAgcmV0dXJuIEBxdWV1ZS5zbGljZSgwLCBsZW5ndGgpXG5cblxuY2xhc3MgU2Vzc2lvblxuICAjIFNlc3Npb24gY29uc3RydWN0b3JcbiAgIyBAcGFyYW0ge1N0cmluZ30gYXJtIHtsZWZ0fHJpZ2h0fVxuICAjIEBwYXJhbSB7U3RyaW5nfSBkaXJlY3Rpb24gIyBub3Qgc3VyZSBhYm91dCB0aGlzIG9uZVxuICBjb25zdHJ1Y3RvcjogKEBtZXNzYWdlUXVldWVMaW1pdCkgLT5cbiAgICBAcG9zZSA9IG51bGxcbiAgICBAbWVzc2FnZXNRdWV1ZSA9IG5ldyBNZXNzYWdlUXVldWUoQG1lc3NhZ2VRdWV1ZUxpbWl0KVxuICAgIEBhcm0gPSBAZGlyZWN0aW9uID0gQHZlcnNpb24gPSBAY29ubmVjdGVkVGltZXN0YW1wID0gQGFybVJlY29nbml6ZWRUaW1lc3RhbXAgPSBudWxsXG5cbiAgICAjIHRoaXMgb2JqZWN0IGNhbiBiZSB1c2VkIGJ5IGN1c3RvbSBldmVudHMgdG8gc3RvcmUgYWRkaXRpb25hbCBkYXRhXG4gICAgQGV4dHJhID0ge31cblxuICBpbml0aWFsaXplOiAtPlxuICAgICMgaGVyZSBJIHdhbnQgdG8gYWRkIGFuIGluaXRpYWxpemF0aW9uIG9mIHRoZSB1c2VyIHNlc3Npb24gb24gdGhlIGFybWJhbmQsXG4gICAgIyByZWdpc3RlcmluZyBjb21tb24gYWN0aW9ucyBqdXN0IHRvIGtub3cgdGhlIHVzZXIgYmV0dGVyIGFuZCBhZGFwdCB0byBoaXNcbiAgICAjIGhhYml0cyBldmVyeSBwZXJzb24gaGFzIGEgZGlmZmVyZW50IHN0cmVuZ3RoIHdoZW4gcGVyZm9ybWluZyBkaWZmZXJlbnRcbiAgICAjIGFjdGlvbnMsIHJlZ2lzdGVyaW5nIGNvbW1vbmcgYWN0aW9ucyB3aWxsIG1ha2UgaXQgZWFzaWVyIHRvIGFkYXB0XG4gICAgIyBhY3Rpb25zIGJhc2VkIG9uIHVzZXIncyBzZW5zaXRpdml0eVxuXG4gIG9uQ29ubmVjdGVkOiAodmVyc2lvbiwgQGNvbm5lY3RlZFRpbWVzdGFtcCkgLT5cbiAgICBAdmVyc2lvbiA9IHZlcnNpb24uam9pbignLicpXG5cbiAgb25Bcm1SZWNvZ25pemVkOiAoQGFybSwgQGRpcmVjdGlvbiwgQGFybVJlY29nbml6ZWRUaW1lc3RhbXApIC0+XG5cbiAgY2xvc2U6IC0+XG4gICAgIyBkbyBzb21ldGhpbmc/IGVtcHR5IHRoZSBtZXNzYWdlIHF1ZXVlP1xuXG5cbmNsYXNzIFN1YnNjcmlwdGlvblxuICBjb25zdHJ1Y3RvcjogKEBjYWxsYmFjaywgQGluZGV4LCBAc3Vic2NyaXB0aW9uTGlzdCkgLT5cblxuICBpbnZva2U6IChhcmdzLi4uKS0+XG4gICAgQGNhbGxiYWNrKGFyZ3MuLi4pXG5cbiAgZGlzcG9zZTogLT5cbiAgICBAc3Vic2NyaXB0aW9uTGlzdC5zcGxpY2UoQGluZGV4LCAwKVxuXG5cbmNsYXNzIEV2ZW50c1xuICBjb25zdHJ1Y3RvcjogLT5cbiAgICBAZXZlbnRzID0ge31cblxuICBvbjogKGV2ZW50TmFtZSwgbGlzdGVuZXIpIC0+XG4gICAgaWYgbm90IEBldmVudHNbZXZlbnROYW1lXVxuICAgICAgQGV2ZW50c1tldmVudE5hbWVdID0gW10gICMgbmV3IHN1YnNjcmlwdGlvbiBsaXN0IGZvciB0aGlzIG5ldyBldmVudFxuXG4gICAgc3Vic2NyaXB0aW9uTGlzdCA9IEBldmVudHNbZXZlbnROYW1lXVxuICAgIHN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oXG4gICAgICBsaXN0ZW5lcixcbiAgICAgIHN1YnNjcmlwdGlvbkxpc3QubGVuZ3RoLFxuICAgICAgc3Vic2NyaXB0aW9uTGlzdFxuICAgIClcbiAgICBzdWJzY3JpcHRpb25MaXN0LnB1c2goc3Vic2NyaXB0aW9uKVxuICAgIHJldHVybiBzdWJzY3JpcHRpb25cblxuICB0cmlnZ2VyOiAoZXZlbnROYW1lLCBhcmdzLi4uKSAtPlxuICAgIHN1YnNjcmlwdGlvbkxpc3QgPSBAZXZlbnRzW2V2ZW50TmFtZV0gb3IgW11cbiAgICBsZW4gPSBzdWJzY3JpcHRpb25MaXN0Lmxlbmd0aFxuXG4gICAgd2hpbGUgbGVuLS1cbiAgICAgIHN1YnNjcmlwdGlvbiA9IHN1YnNjcmlwdGlvbkxpc3RbbGVuXVxuICAgICAgc3Vic2NyaXB0aW9uLmludm9rZShhcmdzLi4uKVxuXG4gIG9mZjogKGV2ZW50TmFtZSkgLT5cbiAgICAjIHRoaXMgY2FuIGJlIHVzZWQgdG8gcmVtb3ZlIGFsbCBzdWJzY3JpcHRpb25zIHRvIGEgc3BlY2lmaWMgZXZlbnQsIHRvXG4gICAgIyBkaXNwb3NlIHNpbmdsZSBzdWJzY3JpcHRpb24gdXNlIHRoZSBkaXNwb3NlIG1ldGhvZCBvbiB0aGVtXG4gICAgQGV2ZW50c1tldmVudE5hbWVdID0gW11cblxuXG5jbGFzcyBQcm94eUV2ZW50TWFuYWdlclxuICAjIFByZXBhcmVzIGV2ZW50IGFuZCBldmVudCBkYXRhIHRvIGJlIHByb3hpZWQgdG8gdGhlIG15byBpbnN0YW5jZVxuICAjIEl0J3MgYWxzbyByZXNwb25zaWJsZSB0byBjcmVhdGUgc2Vzc2lvbnMgYW5kIHVwZGF0ZSB0aGVtLCBvbiBteW8gaW5zdGFuY2VzXG4gICMgQnkgaW5oZXJpdGluZyBmcm9tIHRoaXMgY2xhc3MsIGl0IGlzIHBvc3NpYmxlIHRvIGV4dGVuZCB0aGUgbGlzdCBvZiBldmVudHNcbiAgIyBhIG15byBjYW4gcmVjb2duaXplXG4gIGhhbmRsZTogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIEBpbml0U2Vzc2lvbihteW8sIGV2ZW50RGF0YSlcbiAgICBteW8uc2Vzc2lvbi5tZXNzYWdlc1F1ZXVlLnB1c2goZXZlbnREYXRhKVxuICAgIGhhbmRsZXIgPSBAZ2V0SGFuZGxlcihldmVudERhdGEudHlwZSlcbiAgICBoYW5kbGVyLmNhbGwoQCwgbXlvLCBldmVudERhdGEpXG5cbiAgaW5pdFNlc3Npb246IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBpZiBub3QgbXlvLnNlc3Npb25cbiAgICAgIG15by5zZXNzaW9uID0gbmV3IFNlc3Npb24oKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgcmV0dXJuIHRydWVcblxuICByZW1vdmVTZXNzaW9uOiAobXlvKSAtPlxuICAgIGlmIG15by5zZXNzaW9uXG4gICAgICBteW8uc2Vzc2lvbi5jbG9zZSgpXG5cbiAgICBteW8uc2Vzc2lvbiA9IG51bGxcblxuICBnZXRIYW5kbGVyOiAoZXZlbnRUeXBlKSAtPlxuICAgIHJldHVybiBAW2V2ZW50VHlwZV0gb3IgQC5kZWZhdWx0XG5cbiAgIyBoYW5kbGVyc1xuICBhcm1fcmVjb2duaXplZDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by5zZXNzaW9uLm9uQXJtUmVjb2duaXplZChldmVudERhdGEuYXJtLCBldmVudERhdGEueF9kaXJlY3Rpb24sIGV2ZW50RGF0YS50aW1lc3RhbXApXG4gICAgbXlvLnRyaWdnZXIoJ2FybV9yZWNvZ25pemVkJywgZXZlbnREYXRhKVxuXG4gIGFybV9sb3N0OiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgQHJlbW92ZVNlc3Npb24obXlvKVxuICAgIG15by50cmlnZ2VyKCdhcm1fbG9zdCcsIGV2ZW50RGF0YSlcblxuICBwYWlyZWQ6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcigncGFpcmVkJywgZXZlbnREYXRhKVxuXG4gIHBvc2U6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8uc2Vzc2lvbi5wb3NlID0gZXZlbnREYXRhLnBvc2VcbiAgICBteW8udHJpZ2dlcigncG9zZScsIGV2ZW50RGF0YS5wb3NlKVxuXG4gIG9yaWVudGF0aW9uOiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgbXlvLnRyaWdnZXIoJ29yaWVudGF0aW9uJywgZXZlbnREYXRhKVxuXG4gIHJzc2k6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignYmx1ZXRvb3RoX3N0cmVuZ3RoJywgZXZlbnREYXRhLnJzc2kpXG5cbiAgY29ubmVjdGVkOiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgbXlvLnNlc3Npb24ub25Db25uZWN0ZWQoZXZlbnREYXRhLnZlcnNpb24sIGV2ZW50RGF0YS50aW1lc3RhbXApXG4gICAgbXlvLnRyaWdnZXIoJ2Nvbm5lY3RlZCcsIGV2ZW50RGF0YSlcblxuICBkaXNjb25uZWN0ZWQ6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICAjIGRlc3Ryb3kgbXlvIGluc3RhbmNlP1xuICAgIEByZW1vdmVTZXNzaW9uKG15bylcbiAgICBteW8udHJpZ2dlcignZGlzY29ubmVjdGVkJywgZXZlbnREYXRhKVxuXG4gIGRlZmF1bHQ6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBjb25zb2xlLmxvZygnVW5oYW5kbGVkIGV2ZW50OicsIGV2ZW50RGF0YSlcblxuXG5jbGFzcyBFeHRlbmRlZFByb3h5RXZlbnRNYW5hZ2VyIGV4dGVuZHMgUHJveHlFdmVudE1hbmFnZXJcbiAgb3JpZW50YXRpb246IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICAjIGNvbXBsZXRlbHkgb3ZlcnJpZGVzIHBhcmVudCdzIG9yaWVudGF0aW9uIG1ldGhvZFxuICAgICMgYWRkIGFuIG9mZnNldCB0byB0aGUgb3JpZW50YXRpb24gZGF0YT9cbiAgICBzdGF0ZSA9IG15by5zZXNzaW9uLmV4dHJhXG4gICAgb3JpZW50YXRpb25EYXRhID0ge1xuICAgICAgeDogZXZlbnREYXRhLm9yaWVudGF0aW9uLnggLSBzdGF0ZS56ZXJvT3JpZW50YXRpb25PZmZzZXQueFxuICAgICAgeTogZXZlbnREYXRhLm9yaWVudGF0aW9uLnkgLSBzdGF0ZS56ZXJvT3JpZW50YXRpb25PZmZzZXQueVxuICAgICAgejogZXZlbnREYXRhLm9yaWVudGF0aW9uLnogLSBzdGF0ZS56ZXJvT3JpZW50YXRpb25PZmZzZXQuelxuICAgICAgdzogZXZlbnREYXRhLm9yaWVudGF0aW9uLncgLSBzdGF0ZS56ZXJvT3JpZW50YXRpb25PZmZzZXQud1xuICAgIH1cbiAgICBneXJvc2NvcGVEYXRhID0ge1xuICAgICAgeDogZXZlbnREYXRhLmd5cm9zY29wZVswXVxuICAgICAgeTogZXZlbnREYXRhLmd5cm9zY29wZVsxXVxuICAgICAgejogZXZlbnREYXRhLmd5cm9zY29wZVsyXVxuICAgIH1cbiAgICBhY2NlbGVyb21ldGVyRGF0YSA9IHtcbiAgICAgIHg6IGV2ZW50RGF0YS5hY2NlbGVyb21ldGVyWzBdXG4gICAgICB5OiBldmVudERhdGEuYWNjZWxlcm9tZXRlclsxXVxuICAgICAgejogZXZlbnREYXRhLmFjY2VsZXJvbWV0ZXJbMl1cbiAgICB9XG4gICAgaW11RGF0YSA9IHtcbiAgICAgIGd5cm9zY29wZTogZ3lyb3Njb3BlRGF0YVxuICAgICAgYWNjZWxlcm9tZXRlcjogYWNjZWxlcm9tZXRlckRhdGFcbiAgICAgIG9yaWVudGF0aW9uOiBvcmllbnRhdGlvbkRhdGFcbiAgICB9XG4gICAgc3RhdGUubGFzdE9yaWVudGF0aW9uRGF0YSA9IG9yaWVudGF0aW9uRGF0YVxuXG4gICAgc3VwZXIobXlvLCBvcmllbnRhdGlvbkRhdGEpXG4gICAgQGd5cm9zY29wZShteW8sIGd5cm9zY29wZURhdGEpXG4gICAgQGFjY2VsZXJvbWV0ZXIobXlvLCBhY2NlbGVyb21ldGVyRGF0YSlcbiAgICBAaW11KG15bywgaW11RGF0YSlcblxuICBneXJvc2NvcGU6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignZ3lyb3Njb3BlJywgZXZlbnREYXRhKVxuXG4gIGFjY2VsZXJvbWV0ZXI6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignYWNjZWxlcm9tZXRlcicsIGV2ZW50RGF0YSlcblxuICBpbXU6IChteW8sIGV2ZW50RGF0YSkgLT5cbiAgICBteW8udHJpZ2dlcignaW11JywgZXZlbnREYXRhKVxuXG5cbmNsYXNzIEV4cGVyaW1lbnRhbFByb3h5RXZlbnRNYW5hZ2VyIGV4dGVuZHMgRXh0ZW5kZWRQcm94eUV2ZW50TWFuYWdlclxuICBpbml0U2Vzc2lvbjogKG15bykgLT5cbiAgICBoYWRTZXNzaW9uID0gc3VwZXJcblxuICAgIGlmIG5vdCBoYWRTZXNzaW9uXG4gICAgICBfLmV4dGVuZChteW8uc2Vzc2lvbi5leHRyYSwge1xuICAgICAgICB3YXNSaWdodDogZmFsc2VcbiAgICAgICAgc2Vuc2l0aXZpdHk6IDIwXG4gICAgICAgIGxhc3RJTVU6IG51bGxcbiAgICAgICAgZG91YmxlVGFwOiB7XG4gICAgICAgICAgdGhyZXNob2xkOiAwLjlcbiAgICAgICAgICB0aW1lOiBbODAsIDMwMF1cbiAgICAgICAgfVxuICAgICAgICB6ZXJvT3JpZW50YXRpb25PZmZzZXQ6IHt4OiAwLCB5OiAwLCB6OiAwLCB3OiAwfVxuICAgICAgfSlcblxuICBhY2NlbGVyb21ldGVyOiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgIyBhZGQgZG91YmxlX3RhcCBldmVudFxuICAgICMgYWxsIHJpZ2h0cyBmb3IgdGhpcyBldmVudCBnbyB0byBzdG9sa3Nkb3JmICggaHR0cHM6Ly9naXRodWIuY29tL3N0b2xrc2RvcmYvbXlvLmpzLmdpdCApXG4gICAgc3VwZXJcblxuICAgIHN0YXRlID0gbXlvLnNlc3Npb24uZXh0cmFcblxuICAgIGlmIG5vdCBzdGF0ZS5sYXN0SU1VXG4gICAgICByZXR1cm5cblxuICAgIGRvdWJsZVRhcE9wdGlvbnMgPSBzdGF0ZS5kb3VibGVUYXBcbiAgICBsYXN0ID0gc3RhdGUubGFzdElNVS5hY2NlbGVyb21ldGVyXG5cbiAgICB5ID0gTWF0aC5hYnMoZXZlbnREYXRhLnkpXG4gICAgeiA9IE1hdGguYWJzKGV2ZW50RGF0YS56KVxuICAgIGRlbHRhID0gTWF0aC5hYnMoTWF0aC5hYnMobGFzdC55KSAtIHkpICsgTWF0aC5hYnMoTWF0aC5hYnMobGFzdC56KSAtIHopXG5cbiAgICBpZiBkZWx0YSA+IGRvdWJsZVRhcE9wdGlvbnMudGhyZXNob2xkXG4gICAgICBpZiBzdGF0ZS5sYXN0X3RhcFxuICAgICAgICBkaWZmID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBzdGF0ZS5sYXN0X3RhcFxuXG4gICAgICAgIGlmIGRpZmYgPiBkb3VibGVUYXBPcHRpb25zLnRpbWVbMF0gYW5kIGRpZmYgPCBkb3VibGVUYXBPcHRpb25zLnRpbWVbMV1cbiAgICAgICAgICAjIHRyaWdnZXIgZG91YmxlIHRhcCBldmVudFxuICAgICAgICAgIEBkb3VibGVfdGFwKG15bywgZXZlbnREYXRhKVxuXG4gICAgICBzdGF0ZS5sYXN0X3RhcCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG5cbiAgaW11OiAobXlvLCBldmVudERhdGEpIC0+XG4gICAgIyBhZGQgc2xhcF9sZWZ0IGV2ZW50XG4gICAgbXlvLnNlc3Npb24uZXh0cmEubGFzdElNVSA9IGV2ZW50RGF0YVxuICAgIHN1cGVyXG4gICAgZXZlbnREYXRhID0gZXZlbnREYXRhLm9yaWVudGF0aW9uXG5cbiAgICBzdGF0ZSA9IG15by5zZXNzaW9uLmV4dHJhXG4gICAgc2Vuc1JpZ2h0ID0gKDIwICsgc3RhdGUuc2Vuc2l0aXZpdHkpICogLTFcblxuICAgIGlmIGV2ZW50RGF0YS54IDwgc2Vuc1JpZ2h0IGFuZCBub3Qgc3RhdGUud2FzUmlnaHRcbiAgICAgIHN0YXRlLndhc1JpZ2h0ID0gdHJ1ZVxuICAgICAgcmV0dXJuXG5cbiAgICBzZW5zTGVmdCA9IDgwICsgKHN0YXRlLnNlbnNpdGl2aXR5ICogMilcblxuICAgIGlmIGV2ZW50RGF0YS54ID4gc2Vuc0xlZnQgYW5kIHN0YXRlLndhc1JpZ2h0XG4gICAgICAjIHRyaWdnZXIgc2xhcCBsZWZ0IGV2ZW50XG4gICAgICBAc2xhcF9sZWZ0KG15bywgZXZlbnREYXRhKVxuICAgICAgc3RhdGUud2FzUmlnaHQgPSBmYWxzZVxuXG4gIHNsYXBfbGVmdDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by50cmlnZ2VyKCdzbGFwX2xlZnQnLCBldmVudERhdGEpXG5cbiAgZG91YmxlX3RhcDogKG15bywgZXZlbnREYXRhKSAtPlxuICAgIG15by50cmlnZ2VyKCdkb3VibGVfdGFwJywgZXZlbnREYXRhKVxuXG4gICAgIyBhbHNvIHJlc2V0IG15bydzIG9yaWVudGF0aW9uID9cbiAgICBteW8uemVyb09yaWVudGF0aW9uKClcblxuXG5fLmV4dGVuZChleHBvcnRzLCB7XG4gIEV2ZW50czogRXZlbnRzXG4gIFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uXG4gIFByb3h5RXZlbnRNYW5hZ2VyOiBQcm94eUV2ZW50TWFuYWdlclxuICBFeHRlbmRlZFByb3h5RXZlbnRNYW5hZ2VyOiBFeHRlbmRlZFByb3h5RXZlbnRNYW5hZ2VyXG4gIEV4cGVyaW1lbnRhbFByb3h5RXZlbnRNYW5hZ2VyOiBFeHBlcmltZW50YWxQcm94eUV2ZW50TWFuYWdlclxufSlcbiJdfQ==